<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0">
    <title>Web Socket con Bun</title>
    <link rel="shortcut icon"
        href="https://import.cdn.thinkific.com/643563/kYKQf6voSDC8WPO4l2ug_favicon.ico"
        type="image/x-icon">
    <link rel="stylesheet"
        href="css/styles.css">
</head>

<body>
    <h1>Web Socket Client - Bun.js</h1>

    <hr>

    <div>
        <h3>Estado</h3>
        <p id="status"></p>

        <button id="btn-connect">Connect</button>
        <button id="btn-disconnect">Disconnect</button>
    </div>

    <div>
        <form id="message-form"
            class="hidden">
            <div>
                <h3>Nuevo mensaje</h3>
            </div>
            <div>
                <input type="text"
                    maxlength="50"
                    placeholder="Mensaje"
                    id="input-message">
            </div>
            <button id="btn-send">
                Enviar
            </button>
        </form>
    </div>

    <div>
        <ul id="message-list"></ul>
    </div>

    <script>
        /*
        
            ⏬   VARIABLES Y CONSTANTES

        */

        const channelName = 'chat'
        const serverUrl = `ws://localhost:3000?channelName=${channelName}`

        /*
        
            ⏬   ELEMENTOS - DOM

        */

        const statusElm = document.querySelector("#status")
        const btnConnect = document.querySelector("#btn-connect")
        const btnDisconnect = document.querySelector("#btn-disconnect")
        const btnSend = document.querySelector("#btn-send")
        const inputMessage = document.querySelector("#input-message")
        const messageList = document.querySelector("#message-list")
        const messageForm = document.querySelector("#message-form")

        /*
        
            ⏬   FUNCTIONS

        */

        const createMessageItem = (msg = "") => {
            if (!msg) return null;
            const li = document.createElement('li')

            li.textContent = msg;

            return li;
        }

        const showMessageForm = (show = true) => {
            messageForm.classList.add("hidden")
            if (show) messageForm.classList.remove("hidden")
        }

        const showConnectBtn = (show = true) => {
            if (show) {
                btnConnect.classList.remove("hidden")
                btnDisconnect.classList.add("hidden")
                return
            }

            btnDisconnect.classList.remove("hidden")
            btnConnect.classList.add("hidden")
        }

        const initSocketClient = (url = serverUrl) => {
            /*
                Opening a WebSocket connection

                use client-side WebSocket class
                which extends EventTarget (onmessage, onopen, onclose),
            */
            let socket = new WebSocket(url);

            if (socket.readyState === WebSocket.CONNECTING)
                statusElm.textContent = "Iniciando conexión ... "

            /**
             * Fired when a connection with a WebSocket is opened. 
             * Also available via the onopen property.
            */
            socket.onopen = (event) => {
                console.log("onopen event is here:", !!event);
                console.log("websocket client connected");

                // Mostrar el formulario de carga de mensajes
                showMessageForm()
                showConnectBtn(false)

                if (socket.readyState === WebSocket.OPEN)
                    statusElm.textContent = "Conectado"
            }

            /**
             * Fired when data is received through a WebSocket. 
             * Also available via the onmessage property.
            */
            socket.onmessage = (event) => {
                const msg = String(event.data).trim();
                console.log("onmessage event is here:", !!event);
                console.log("new message:", msg);   
                messageList.appendChild(createMessageItem(msg))
            }

            /**
             * Fired when a connection with a WebSocket has been closed because of an error,
             * such as when some data couldn't be sent. 
             * Also available via the onerror property.
            */
            socket.onerror = (event) => {
                console.log("onerror event is here:", !!event);
                console.error("An Error has occurred", event);

                // Esconder el formulario de carga de mensajes
                showMessageForm(false)
                showConnectBtn()
                statusElm.textContent = "Ocurrio un error"
            }

            /**
             * Fired when a connection with a WebSocket is closed. 
             * Also available via the onclose property
            */
            socket.onclose = (event) => {
                console.log("onclose event is here:", !!event);
                console.log("websocket client disconnected");

                // Esconder el formulario de carga de mensajes
                showMessageForm(false)
                showConnectBtn()

                if (socket.readyState === WebSocket.CLOSED)
                    statusElm.textContent = "Desconectado"
            }

            return socket;
        }

        /*
        
        ⏬   EVENTS HANDLERS
        
        */
        let socket = initSocketClient()

        btnConnect.addEventListener('click', async () => {
            /**
             * Socket ready state
             * 
             * A number which is one of the four possible state constants
             * defined on the WebSocket interface:
             * 
             * WebSocket.CONNECTING (0) - Socket has been created.
             * The connection is not yet open.
             * WebSocket.OPEN (1) The connection 
             * is open and ready to communicate.
             * WebSocket.CLOSING (2) The connection is in the
             * process of closing.
             * WebSocket.CLOSED (3) The connection is closed or
             * couldn't be opened.
            */

            if (socket.readyState === WebSocket.OPEN)
                return;

            socket = initSocketClient();
        })

        btnDisconnect.addEventListener('click', () => {
            if (socket.readyState === WebSocket.CLOSING)
                statusElm.textContent = "Cerrando conexión ... "

            if (socket.readyState !== WebSocket.OPEN) {
                console.log("socket status:", socket.readyState);
                return;
            }

            messageList.innerHTML = '';

            socket.close("4404", 'Not found')
        })

        messageForm.addEventListener('submit', evt => {
            // tells the user agent that the event is being
            // explicitly handled, so its default action, such
            // as page scrolling, link navigation, or pasting
            // text, should not be taken.
            evt.preventDefault();

            let msg = inputMessage.value;
            inputMessage.value = "";

            if (!msg) return;

            msg = String(msg).trim().substring(0,50);

            socket.send(msg);
        })


        // console.warn(
        //     statusElm,
        //     btnConnect,
        //     btnDisconnect,
        //     btnSend,
        //     inputMessage,
        //     messageList,
        //     messageForm
        // )
    </script>
</body>

</html